---
title: "Project_1_607"
author: "Salma Elshahawy"
date: "9/16/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

```{r}
library(RCurl)
url <- 'https://raw.githubusercontent.com/salma71/MSDS_2019/master/Fall2019/aquisition%26management_607/project_1/tournamentinfo.txt'

# reading the url as a dataframe
tourn <- read.delim(url, header = FALSE, stringsAsFactors = FALSE)
head(tourn) 
#%>% kable() %>% kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive")) %>% scroll_box(width="100%",height="300px")
```


```{r}
dim(tourn)
```

## Clean up the data 

1. removing the (-)  
```{r}
library(htmlTable)
library(magrittr)
library(kableExtra)
library(dplyr)
library(stringr)
library(tidyverse)
```

```{r}
tourn_df <- as.data.frame(tourn)
tourn_df

```

```{r}
# removing --- 
tourn_2 <- data.frame(str_remove_all(tourn_df$V1,"(\\-+)"))
head(tourn_2)
```


* delete empty lines
```{r}
tourn_2 <- data.frame(tourn_2[!apply(tourn_2 == "", 1, all),])
tourn_2
```



```{r}
# Need to define an empty new_dataframe
new_table <- data.frame(c())
# Combining two consecutive rows into one column
for (i in 1:dim(tourn_2)[1]){
  if (i %% 2 == 1) {
    Part1 <- rbind(new_table$Part1, as.character(tourn_2[i,1]))
    Part2 <- as.character(tourn_2[i+1,1])
    binded <- data.frame(paste0(Part1, Part2))
    names(binded) <- "Binded"
    new_table <- rbind(new_table, binded)
  } 
}
head(new_table)
#%>% kable() %>% kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive")) %>% scroll_box(width="100%",height="300px")
is.data.frame(new_table)
```

2. seperate the columns into multiple ones
```{r}
into <- c("Pair", "Player Name","Total","Round","Round.1","Round.2","Round.3","Round.4","Round.5","Round.6","State","USCF ID / Rtg (Pre>Post)","Pts","1","2", "3","4","5","6", "7")
splitted_df <- separate(new_table, Binded, into, sep = "\\|")
splitted_df

```

```{r}
colnames(splitted_df)
```

delete the first row 
```{r}
clean_df <- splitted_df[-c(1),]
clean_df
```

```{r}
colnames(clean_df)
dim(clean_df)
```
clean up the USCF ID / Rtg (Pre>Post) to get the re-rating 

```{r}
rtg_extract <- str_extract_all(clean_df$`USCF ID / Rtg (Pre>Post)`, "\\b\\d{1,}")
#as.data.frame(rtg_split)

colnames(rtg_extract, do.NULL = FALSE) 
#<- c("USCF ID", "Pre", "Post")
rtg_split <- str_split_fixed(rtg_extract, "[[:punct:]]\\s+", 3)
#rtg_split

rtg_df <- data.frame(as.character(str_remove_all(rtg_extract, "[[:punct:],c]")))
rtg_df
is.data.frame(rtg_df)
header_name <- c("USCF ID", "Pre", "Post")
# rename colums
colnames(rtg_df)
names(rtg_df)[names(rtg_df) == "as.character.str_remove_all.rtg_extract......punct...c...."] <- "years"

rtg_df <- separate(rtg_df, years, header_name, sep = " ") 
rtg_df
```

Now we need to merge those three col into the main dataframe
first : we need to drop the "USCF ID / Rtg (Pre>Post)" column and merge instead the dataframe with three col

```{r}
clean_df
```

```{r}
colnames(clean_df)
```
```{r}
drop_uncleandata <- clean_df[,-c(12)]
drop_uncleandata

```

bind the new three col

```{r}
tournament_df <- cbind(drop_uncleandata, rtg_df)
tournament_df
```
 check col names and position 
 
```{r}
colnames(tournament_df)
```
reordering the col

```{r}
ordered_tournament_df <- tournament_df[c(1,2,11,3,21,22,12,4,5,6,7,8,9,10,13,14,14,16,17,18,19,20)]
ordered_tournament_df
```

```{r}
colnames(ordered_tournament_df)
```


taking a subset data

```{r}
final_table <- subset(ordered_tournament_df, select = c(1:7))
head(final_table)
#my_var <- c(1,2,3,4,5)
final_table$avg_rtg <- 0
final_table
#tournament_subset
```

bind new col for avg 

```{r}
#score table
score_df <- subset(ordered_tournament_df, select = c(1:2))
score_df
#final_table$NGames <- c(0)
#final_table
```






```{r}
opponent1 <- data.frame(as.numeric(str_extract_all(ordered_tournament_df$`Round`,"[[:digit:]]{1,}")))
opponent2 <- data.frame(as.numeric(str_extract_all(ordered_tournament_df$`Round.1`,"[[:digit:]]{1,}")))
opponent3 <- data.frame(as.numeric(str_extract_all(ordered_tournament_df$`Round.2`,"[[:digit:]]{1,}")))
opponent4 <- data.frame(as.numeric(str_extract_all(ordered_tournament_df$`Round.3`,"[[:digit:]]{1,}")))
opponent5 <- data.frame(as.numeric(str_extract_all(ordered_tournament_df$`Round.4`,"[[:digit:]]{1,}")))
opponent6 <- data.frame(as.numeric(str_extract_all(ordered_tournament_df$`Round.5`,"[[:digit:]]{1,}")))
opponent7 <- data.frame(as.numeric(str_extract_all(ordered_tournament_df$`Round.6`,"[[:digit:]]{1,}")))

# Creeating Opponents data frame.
opponents <- cbind(score_df, opponent1, opponent2, opponent3, opponent4, opponent5, opponent6, opponent7)

# Finding number of games played
for(i in 1:dim(opponents)[1]){
    opponents$NGames[i] <- 7 - as.numeric(sum(is.na(opponents[i,])))
}

# Reporting  to view the opponents table
opponents
names(opponents) <- c("Pair","Player Name","Opp 1","Opp 2","Opp 3","Opp 4","Opp 5","Opp 6","Opp 7", "NGames")
opponents
```

```{r}
colnames(opponents)
```



```{r}
# Eliminating NA Cases in order to continue with our calculations, NA replaced by 0.
opponents[is.na(opponents)] <- as.numeric(0)
opponents
```
```{r}

final_table
```

```{r}
final_df <- merge(final_table, opponents)
final_df
colnames(final_df)
```

```{r}
# Procedure to calculate Average Pre-Rating for each player

for (k in 3:9){
  for (j in 1:dim(final_table)[1]){ 
    for (i in 1:dim(final_table)[1]){
      if (as.numeric(opponents[j,k]) == as.numeric(final_table$Pair[i])){
        final_table$avg_rtg[j] <- as.numeric(final_table$avg_rtg[j]) + as.numeric(final_table$Pre[i]) 
      }
    }
  }
}


final_table$avg_rtg <- round(as.numeric(final_table$avg_rtg) / as.numeric(opponents$NGames),0)
final_table

```


## Export to CSV file 

```{r}
file_to_export <- write.table(final_table, file = "chess_tournamentInfo.csv", row.names = FALSE, na="", col.names = TRUE, sep = ",")
file_to_export
```

## open the file

```{r}
file_to_open <- read.csv(file = "chess_tournamentInfo.csv", header = TRUE, sep = ",")
file_to_open
```